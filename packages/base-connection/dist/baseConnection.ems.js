function e(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var n,i;!function(e){e.SUBSCRIBE="subscribe",e.EMIT="emit",e.REQUEST="request",e.RESOLVE="resolve",e.REJECT="reject"}(n||(n={})),function(e){e.HANDSHAKE="mc-handshake",e.CONNECTED="mc-connected",e.DISCONNECTED="mc-disconnected",e.CONNECTION_TIMEOUT="mc-connection-timeout"}(i||(i={}));var o=Object.freeze({__proto__:null,get MESSAGE_TYPE(){return n},get MC_EVENTS(){return i}}),s=function(){function o(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e(this,o),this.connected=!1,this.backlog=[],this.promises={},this.emitters={},this.connectionStep="",this.defaultOptions={window:window,connectionTimeout:2e3,timeout:200,debug:!1,onload:!0,clientInitiates:!1,targetOrigin:"*"},this.options=Object.assign(Object.assign({},this.defaultOptions),t)}var s,r,a;return s=o,(r=[{key:"emit",value:function(e,t){return this.message({type:n.EMIT,event:e,payload:t}),this}},{key:"on",value:function(e,t){return this.emitters[e]&&Array.isArray(this.emitters[e])?this.emitters[e].push(t):this.emitters[e]=[t],this}},{key:"request",value:function(e,t){var i=this,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return new Promise((function(s,r){var a,c=i.uuidv4(),u=i.getRequestTimeout(o.timeout);!1!==u&&"number"==typeof u&&(a=window.setTimeout((function(){return r("timeout")}),u)),i.promises[c]={resolve:function(e){s(e),a&&clearTimeout(a)},reject:function(e){r(e),a&&clearTimeout(a)}},i.message({type:n.REQUEST,event:e,id:c,payload:t})}))}},{key:"close",value:function(){this.connected&&(this.port.close(),this.connected=!1),this.messageListener&&this.options.window.removeEventListener("message",this.messageListener,!1)}},{key:"setConnectionTimeout",value:function(){var e=this;clearTimeout(this.connectionTimeout),!1!==this.options.connectionTimeout&&(this.connectionTimeout=window.setTimeout((function(){e.messageListener&&e.options.window.removeEventListener("message",e.messageListener,!1),e.handleMessage({type:n.EMIT,event:i.CONNECTION_TIMEOUT,payload:{message:"Connection timed out while "+e.connectionStep}})}),Number(this.options.connectionTimeout)))}},{key:"uuidv4",value:function(){var e=window.crypto||window.msCrypto;return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(function(t){return(t^e.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16)}))}},{key:"clearConnectionTimeout",value:function(){clearTimeout(this.connectionTimeout)}},{key:"initPortEvents",value:function(){var e=this;this.port.onmessage=function(t){e.handleMessage(t.data)},this.port.onmessageerror=function(t){e.handleError(t)}}},{key:"finishInit",value:function(){this.connected=!0,this.clearConnectionTimeout(),this.options.debug&&console.log("Finished connection on ".concat(this.isClient()?"client":"server")),this.emit(i.CONNECTED),this.completeBacklog()}},{key:"completeBacklog",value:function(){var e=this;this.backlog.forEach((function(t){e.portMessage(t)})),this.backlog=[]}},{key:"handleError",value:function(e){this.options.debug&&console.error(e)}},{key:"handleMessage",value:function(e){var t=this;switch(this.options.debug&&console.log("handle by ".concat(this.isClient()?"client":"server"," - [").concat(e.type,': "').concat(e.event,'"] , payload: '),e.payload),e.type){case n.EMIT:if(!this.emitters[e.event]||!Array.isArray(this.emitters[e.event]))return;this.emitters[e.event].forEach((function(t){return t(e.payload)}));break;case n.REQUEST:if(!this.emitters[e.event]||!Array.isArray(this.emitters[e.event]))return;this.emitters[e.event].forEach((function(i){return i(e.payload,(function(i){t.message({id:e.id,type:n.RESOLVE,event:e.event,payload:i})}),(function(i){t.message({id:e.id,type:n.REJECT,event:e.event,payload:i})}))}));break;case n.RESOLVE:if(!this.promises[e.id])return;this.promises[e.id].resolve(e.payload),delete this.promises[e.id];break;case n.REJECT:if(!this.promises[e.id])return;this.promises[e.id].reject(e.payload),delete this.promises[e.id]}}},{key:"getRequestTimeout",value:function(e){return"number"==typeof e&&e>=0?e:"number"==typeof e?0:(!0===e||!1!==e)&&this.options.timeout}},{key:"isClient",value:function(){return!1}},{key:"message",value:function(e){var t=!1;e.event!==i.HANDSHAKE&&e.event!==i.CONNECTED&&e.event!==i.DISCONNECTED||(t=!0),this.connected||t?this.port&&this.portMessage(e):this.backlog.push(e)}},{key:"portMessage",value:function(e){this.options.debug&&console.log("send from ".concat(this.isClient()?"client":"server"," - [").concat(e.type,": ").concat(e.event,"], payload: "),e.payload),this.port.postMessage(e)}}])&&t(s.prototype,r),a&&t(s,a),o}();export{s as Connection,o as types};
